# Setting Up Your Project

## Get Some Data
To get started playing with NCPI Whistler, you'll need some data to transform. Luckily, we have you covered there when you clone this repository. So, the first step is just to perform a git clone:
```
git clone https://github.com/NIH-NCPI/NCPI-Whistler-Tutorial
```

When completed, change into the new directory:
```
cd NCPI-Whistler-Tutorial
```

From that new directory, you'll find a few key directories which represent our fictitious study: 
* data - This directory contains the all of our "study's" CSV files and their corresponding data-dictionaries.
* harmony - This directory contains a single CSV file which is prefilled with the relevant mappings of local dataset terms to public ontology entries. 

Now that we have our data "at our fingertips", so to speak, it's time to tell Whistler how what to do.

## FHIR Server Configuration
The first thing you'll need to do is to set up a FHIR Hosts file. This step is required even if you have no plans to submit the final results of your transformations to a real FHIR Server. Luckily, NCPI Whistler can generate one for you with a single command:
```
play > fhir_hosts
```

When play is run inside a directory without a fhir_hosts file, it dumps an example file to standard out. The command above takes advantage of that behavior by redirecting the output to the expected file name. 

This new file will have an example entry for each of the currently supported FHIR Authentication methods. Please edit the appropriate entry in the new file to properly authenticate with your specific server named 'tutorial'. For example, the autogenerated hosts file has an entry named 'dev' that is of type: 'auth_basic'. If this is the method we should use for our test server, change the key, 'dev' at the start of that configuration block to 'tutorial'. 

It is unlikely that any of the default settings that matter for these will happen to match those that you need, so you'll have to make the necessary changes. For all of them, that includes "target_service_url". For 'auth_basic', you'll need to change the username and password. Each of the others have their own key properties that will be required. 

> For security's sake, you should **NEVER** check the fhir_hosts file into source control if it has sensitive information such as usernames and passwords or cookie info. The same goes for token files for service accounts. Those should be added to any ignore file used by your version control software (such as .gitignore). It is generally recommended that these files have very strict read permissions (only readable by yourself). 

An example of what a final local development FHIR server using basic auth can be seen below:
```
tutorial:
    auth_type: 'auth_basic'
    username: 'myusername'
    password: 'mypassword'
    host_desc: 'Example auth_basic'
    target_service_url: 'http://localhost:8000'
```

Read more about the file, [*fhir_hosts*](https://nih-ncpi.github.io/ncpi-whistler/#/?id=fhir-hosts). 

## Study Configuration
Whistler configuration files are simple YAML files which provide whistler with information about the study itself including entries for each of the CSV files that should be transformed. Except for *delfhir*, all Whistler commands require one or more configuration files to run. 

### Creating the Configuration File
YAML is a very easy to read file format that uses plain text. To get started, open up the file, 'study.yaml' in your favorite editor and add the following lines of text:
```yaml
# The study_id should be unique across the target FHIR Server
study_id: TUT

# An optional DbGAP Study Accession ID can be provided
study_accession:

# The Study's official Title
study_title: NCPI Whistler Tutorial

# A descriptive text block. This can be added to the FHIR ResearchStudy resource
study_desc: This is just some fake data

# The relevant URL associated with the study's presence on the web
url: https://some-place.org/studies/tut

# This prefix will be used for the various identifier systems. This prefix 
# MUST be unique to the target servers for this study only. 
identifier_prefix: https://some-place.org/tut/fhir
```
When Whistler extracts data from the CSV files, it will create a single *study* object populated by these root variables. By writing your whistle code to pull these values from the study object itself rather than hard coding them into the Whistle code itself makes your code more reusable. As such, it is highly recommended to fill out as many of the fields as you can when writing your configuration. 

The first variable defines the *id* for the study as *study_id*. Ideally, this should be a very unique identifier, but at the very least, it should be unique for all of the target servers where the data will be loaded. 

The values, *study_title*, *study_desc*, *url* and *study_accession* can be used to populate the ResearchStudy resource.

*identifier_prefix* is a bit different. While it will be added to the study object that is passed to whistle, it is expected to be used for the purpose of generating appropriate identifier system properties. 

The next few lines are used by NCPI Whistler itself. 

```yaml
# This is a simple prefix that will be appended to the various output files
# produced during Whistler's execution. This is only used on the local disk
output_filename: tut

# The directory where all of the whistle code can be found
projector_lib: projector

# The directory containing the Harmony table 
code_harmonization_dir: harmony

# The entry point Whistle function. This refers to a file that lives outside
# the projector library path
whistle_src: _entry.wstl

# The default id used to associate a row of data to a participant
id_colname: subject_id

# If curies are not baked into the Harmony target codes, then you can have 
# whistler bake them in for you. 
curies:
  http://purl.obolibrary.org/obo/hp.owl: HP
  http://purl.obolibrary.org/obo/mondo.owl: MONDO
  http://purl.obolibrary.org/obo/maxo.owl: MAXO

# Mappings for the standard development environments local, dev, qa and prod
# The values listed below would theoretically appear in the fhir_hosts file
# and can each be a completely different type of authentication from the others. 
env:
  local: tutorial
  dev: tutorial
  qa: my-qa-server
  prod: my-prod-server
```
The *output_filename* is used in filenames for intermediate and final output produced by Whistler. When creating projects that share whistle projections (i.e. reside in the same project directory), be sure that they all have different *output_filename* values so that they don't overwrite one another. 

*projector_lib* tells whistle where to find the whistle code, or projector library,  and *code_harmonization_dir* points to the directory where the harmony CSV files live. 

*whistle_src* points to whistle entry point. We'll discuss this later. The important thing to know about this is that it **must** not reside inside the projector library. 

*id_colname* is used by some of the optional autogenerated code to identify which patient a particular row is referring to. *curies* provides a mapping of ontology system to curie when you want whistler to attach curies to otherwise naked codes found in the harmony files when it builds the ConceptMaps. 

The *env* portion simply maps standard development environments to entries from your *fhir_hosts* file for convenience. Imagine that you have several studies that share a common whistle projection but must be loaded into different servers. You could then load all three with a single command, specifying which environment to load into. 

### Adding The Datasets
The next part of the configuration gets to be a little bit trickier. For this part, we'll need to enumerate each of our data tables inside a single *dataset* property. Each of those tables will have several different parameters to inform whistler where to find the data, where to find the data-dictionary, details about alternate header mappings, etc. 


```yaml
dataset:
```


Read more about the [configuration file](https://nih-ncpi.github.io/ncpi-whistler/#/?id=project-configuration). 

